"use strict";statracker.factory("accountService",["$http","$q","localStore","jwtHelper","apiUrl","tokenUrl","clientId",function(e,t,r,o,n,s,a){var i={authenticated:!1},u=function(n){var u=t.defer(),l="grant_type=password&username="+encodeURIComponent(n.email)+"&password="+encodeURIComponent(n.password)+"&client_id="+encodeURIComponent(a);return e({url:s,method:"POST",data:l,skipAuthorization:!0,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(e){var t=o.decodeToken(e.access_token);i.authenticated=!0,i.id=t.nameid,i.name=t.sub,i.email=t.sub,r.set("user",i),r.set("access_token",e.access_token),r.set("refresh_token",e.refresh_token),u.resolve()}).error(function(e){c(),u.reject(e)}),u.promise},c=function(){return i.authenticated&&e.post(n+"account/logout"),r.remove("access_token"),r.remove("refresh_token"),r.remove("user"),i={authenticated:!1}},l=function(t){return c(),e({url:n+"account/register",method:"POST",data:t,skipAuthorization:!0})},d=function(){if(void 0!==i.id)return i;var e=r.get("user");return void 0!==e&&null!==e&&(i=e),i},h=function(){var t=r.get("refresh_token"),o="grant_type=refresh_token&refresh_token="+encodeURIComponent(t)+"&client_id="+encodeURIComponent(a);return t?e({url:s,method:"POST",skipAuthorization:!0,data:o,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(e){r.set("access_token",e.access_token),r.set("refresh_token",e.refresh_token)}).error(function(){c()}):void 0};return{login:u,logout:c,register:l,user:d,refresh:h}}]),statracker.controller("ClubDetailController",["$state","$scope","userDataService",function(e,t,r){var o=this;r.getDefaultClubs().then(function(e){o.clubs=e}),t.$on("$ionicView.beforeEnter",function(){o.userClub=e.params.club}),o.saveClub=function(){if(o.userClub.key)r.updateClub(o.userClub).then(function(){e.go("^.my-bag")});else{var t=o.clubs.find(function(e){return e.key===o.userClub.clubKey});o.userClub.key=0,o.userClub.club={key:t.key,clubName:t.name},r.addClub(o.userClub).then(function(){e.go("^.my-bag")})}}}]),statracker.controller("CourseDetailController",["$state","$scope","userDataService",function(e,t,r){var o=this;t.$on("$ionicView.beforeEnter",function(){r.getCourse(e.params.key).then(function(e){o.course=e.data})}),o.saveCourse=function(){o.course.key?r.updateCourse(o.course).then(function(){e.go("^.course-list")}):(o.course.key=0,r.createCourse(o.course).then(function(){e.go("^.course-list")}))}}]),statracker.controller("CourseListController",["$ionicPopup","userDataService","userData",function(e,t,r){var o=this;o.courses=r.courses,o.showDelete=!1,o.deleteCourse=function(r){var n=e.confirm({title:"Delete Course",template:"Are you sure you want to permanently delete this course?"});n.then(function(e){e&&t.deleteCourse(r).then(function(e){o.courses=e,o.showDelete=!1})})}}]),statracker.controller("LoginController",["$state","accountService",function(e,t){var r=this;r.credentials={email:"",password:"",hasError:!1,error:""},r.canLogin=function(){return r.credentials.email&&r.credentials.email.length>0&&r.credentials.password&&r.credentials.password.length>0?!0:!1},this.doLogin=function(){r.credentials.hasError=!1,r.credentials.error="",t.login(this.credentials).then(function(){e.go("tab.rounds")},function(e){r.credentials.hasError=!0,r.credentials.error=null===e?"Cannot reach the StaTracker authorization server":e.error_description})}}]),statracker.directive("login",[function(){return{scope:{},templateUrl:"js/account/login.html",replace:!0,bindToController:!0,controller:"loginController",controllerAs:"ctrl"}}]).controller("loginController",["$state","accountService",function(e,t){this.credentials={email:"",password:"",hasError:!1,error:""},this.doLogin=function(){this.credentials.hasError=!1,this.credentials.error="",t.login(this.credentials).success(function(){e.go("tab.rounds")}).error(function(e){this.credentials.hasError=!0,this.credentials.error=e.error_description})}}]),statracker.controller("MyBagController",["$scope","userDataService","userData",function(e,t,r){var o=this;o.showDelete=!1,e.$on("$ionicView.beforeEnter",function(){o.userClubs=r.clubs}),o.deleteClub=function(e){t.removeClub(e).then(function(e){o.userClubs=e,o.showDelete=!1})}}]),statracker.directive("myCourses",["$ionicTemplateLoader","$ionicBackdrop","$timeout","$rootScope","$document",function(e,t,r,o,n){return{require:"?ngModel",restrict:"E",template:'<input type="text" class="my-courses-control" autocomplete="off">',replace:!0,scope:{courses:"="},link:function(o,s,a,i){o.filteredCourses=o.courses;var u,c=['<div class="my-courses-container">','<div class="bar bar-header item-input-inset">','<label class="item-input-wrapper">','<i class="icon ion-ios7-search placeholder-icon"></i>','<input type="search" ng-model="searchQuery" placeholder="Enter a course description">',"</label>",'<button class="button button-clear">Save</button>',"</div>",'<ion-content class="has-header">',"<ion-list>",'<ion-item ng-repeat="course in filteredCourses" type="item-text-wrap" ng-click="selectCourse(course)">',"{{course.courseDescription}}","</ion-item>","</ion-list>","</ion-content>","</div>"].join("");e.compile({template:c,scope:o,appendTo:n[0].body}).then(function(e){var n=angular.element(e.element.find("input"));o.selectCourse=function(r){i.$setViewValue(r),i.$render(),e.element.css("display","none"),t.release()},o.$watch("searchQuery",function(e){u&&r.cancel(u),u=r(function(){e&&o.$apply(function(){o.courses&&o.courses.length>0&&(o.filteredCourses=o.courses.filter(function(t){return""===e||t.courseDescription.startsWith(e)?t:void 0}))})},100)});var a=function(r){r.preventDefault(),r.stopPropagation(),t.retain(),e.element.css("display","block"),n[0].focus(),setTimeout(function(){n[0].focus()},0)},c=function(){var r={key:0,courseDescription:n[0].value};i.$setViewValue(r),i.$render(),o.searchQuery="",t.release(),e.element.css("display","none"),o.$emit("new-course",n[0].value)};s.bind("click",a),s.bind("touchend",a),e.element.find("button").bind("click",c)}),a.placeholder&&s.attr("placeholder",a.placeholder),i.$formatters.unshift(function(e){return e?e:""}),i.$parsers.unshift(function(e){return e}),i.$render=function(){s.val(i.$viewValue?i.$viewValue.courseDescription||"":"")}}}}]),statracker.controller("RegisterController",["$state","accountService","userDataService",function(e,t,r){var o=this,n=[{key:0,clubKey:0,club:{key:0,clubName:"Driver"},teeballFlag:!0,approachFlag:!1,sortOrderNumber:1},{key:0,clubKey:0,club:{key:0,clubName:"3 Wood"},teeballFlag:!0,approachFlag:!1,sortOrderNumber:2},{key:0,clubKey:0,club:{key:0,clubName:"5 Wood"},teeballFlag:!0,approachFlag:!1,sortOrderNumber:3},{key:0,clubKey:0,club:{key:0,clubName:"4 Iron"},teeballFlag:!1,approachFlag:!0,sortOrderNumber:4},{key:0,clubKey:0,club:{key:0,clubName:"5 Iron"},teeballFlag:!1,approachFlag:!0,sortOrderNumber:5},{key:0,clubKey:0,club:{key:0,clubName:"6 Iron"},teeballFlag:!1,approachFlag:!0,sortOrderNumber:6},{key:0,clubKey:0,club:{key:0,clubName:"7 Iron"},teeballFlag:!1,approachFlag:!0,sortOrderNumber:7},{key:0,clubKey:0,club:{key:0,clubName:"8 Iron"},teeballFlag:!1,approachFlag:!0,sortOrderNumber:8},{key:0,clubKey:0,club:{key:0,clubName:"9 Iron"},teeballFlag:!1,approachFlag:!0,sortOrderNumber:9},{key:0,clubKey:0,club:{key:0,clubName:"Pitching Wedge"},teeballFlag:!1,approachFlag:!0,sortOrderNumber:10},{key:0,clubKey:0,club:{key:0,clubName:"Sand Wedge"},teeballFlag:!1,approachFlag:!0,sortOrderNumber:11}];r.getDefaultClubs().then(function(e){n.forEach(function(t,r){var o=e.find(function(e){return t.club.clubName===e.name});o?(n[r].clubKey=o.key,n[r].club.key=o.key):console.log("what gives?")}),r.addClubs(n).then(function(e){this.clubs=e})}),o.registration={email:"",password:"",confirmPassword:"",hasError:!1,error:""},o.doRegister=function(){o.registration.hasError=!1,o.registration.error="",o.validate()&&t.register(o.registration).success(function(){t.login(o.registration).then(function(){r.getDefaultClubs().then(function(t){n.forEach(function(e,r){var o=t.find(function(t){return e.club.clubName===t.name});o?(n[r].clubKey=o.key,n[r].club.key=o.key):console.log("what gives?")}),r.addClubs(n).then(function(){e.go("tab.rounds")})})})}).error(function(e){o.registration.hasError=!0,o.registration.error=e.error_description?e.error_description:e.modelState?e.modelState:e})},o.validate=function(){return""===o.registration.email?(o.registration.hasError=!0,o.registration.error="An email address is required",!1):""===o.registration.password?(o.registration.hasError=!0,o.registration.error="A password is required",!1):o.registration.password!==o.registration.confirmPassword?(o.registration.hasError=!0,o.registration.error="The passwords do not match",!1):!0}}]),statracker.controller("UserController",["$scope","$state","accountService",function(e,t,r){e.user=r.user(),e.doLogout=function(){r.logout(),t.go("login")}}]),statracker.factory("userDataService",["$http","$q","apiUrl",function(e,t,r){var o=[],n=[],s=[],a=function(){var s=t.defer(),a=t.defer();return o&&o.length>0?s.resolve(o):e.get(r+"users/clubs").then(function(e){e.data&&(o=e.data),s.resolve(o)}),n&&n.length>0?a.resolve(n):e.get(r+"users/courses").then(function(e){e.data&&(n=e.data),a.resolve(n)}),t.all([s.promise,a.promise]).then(function(e){return{clubs:e[0],courses:e[1]}})},i=function(o){var s=t.defer(),a=o.description+"("+o.tees+")",i=n&&n.find(function(e){return e.description.toLowerCase()===a.toLowerCase()});if(i)s.resolve(i);else{var u={key:0,courseDescription:o.description,teesName:o.tees,holesNumber:o.holes,parNumber:o.par};e.post(r+"users/courses",u).then(function(e){n.push({key:e.data.key,description:e.data.courseDescription+" ("+e.data.teesName+")",holes:e.data.holesNumber}),s.resolve(e.data)})}return s.promise},u=function(o){var s=t.defer(),a=o.courseDescription+"("+o.teesName+")",i=n&&n.find(function(e){return e.description.toLowerCase()===a.toLowerCase()});return i?s.reject("A course named "+a+" already exists"):e.post(r+"users/courses",o).then(function(e){n.push({key:e.data.key,description:e.data.courseDescription+" ("+e.data.teesName+")",holes:e.data.holesNumber}),s.resolve(e.data)}),s.promise},c=function(t){return e.put(r+"users/courses/"+t.key,t)},l=function(o){var s=t.defer(),a=n.findIndex(function(e){return e.key===o.key});return e.delete(r+"users/courses/"+o.key).then(function(){n.splice(a,1),s.resolve(n)}),s.promise},d=function(t){return e.get(r+"users/courses/"+t)},h=function(t){return e.get(r+"users/clubs/"+t)},f=function(n){var s=t.defer();return e.post(r+"users/clubs",n).then(function(e){o.push(e.data),s.resolve(o)}),s.promise},p=function(n){var s=t.defer();return e.put(r+"users/clubs",n).then(function(){e.get(r+"users/clubs").then(function(e){e.data&&(o=e.data,s.resolve(o))})}),s.promise},g=function(n){var s=t.defer(),a=o.findIndex(function(e){return e.key===n.key});return o[a]=n,e.put(r+"users/clubs/"+n.key,n).then(function(){s.resolve(o)}),s.promise},m=function(n){var s=t.defer(),a=o.findIndex(function(e){return e.key===n.key});return e.delete(r+"users/clubs/"+n.key).then(function(){o.splice(a,1),s.resolve(o)}),s.promise},v=function(){var o=t.defer();return s&&s.length>0?o.resolve(s):e.get(r+"clubs").then(function(e){e.data&&(s=e.data.map(function(e){var t=!0,r=!1;return"Driver"===e.clubName||e.clubName.endsWith("Wood")?(t=!1,r=!0):"Putter"===e.clubName&&(t=!1),{key:e.key,name:e.clubName,sortOrder:e.key,approachFlag:t,teeballFlag:r}})),o.resolve(s)}),o.promise};return{get clubs(){return o},get courses(){return n},getDefaultClubs:v,loadUserData:a,addCourse:i,getCourse:d,createCourse:u,updateCourse:c,deleteCourse:l,getClub:h,addClub:f,addClubs:p,updateClub:g,removeClub:m}}]),statracker.directive("holesSelect",["$parse",function(e){return{restrict:"EA",replace:!0,require:"ngModel",template:'<div class="holes-container button-bar"><a class="button button-holes button-small">9</a><a class="button button-holes button-small">18</a></div>',link:function(t,r,o,n){var s,a=r.find("a"),i=e(o.ngModel)(t);s=function(e){angular.forEach(a,function(t){var r=angular.element(t);t.innerText==e?r.hasClass("button-calm")?(r.removeClass("button-stable"),r.addClass("button-outline")):(r.addClass("button-calm"),r.removeClass("button-outline")):r.hasClass("button-calm")?(r.removeClass("button-calm"),r.addClass("button-outline")):(r.addClass("button-stable"),r.removeClass("button-outline"))})},r.bind("click",function(){i=void 0===i?18:9===i?18:9,n.$setViewValue(i),s(i)}),s(i)}}}]),statracker.config(["$httpProvider","jwtInterceptorProvider",function(e,t){t.tokenGetter=["localStore","jwtHelper","accountService",function(e,t,r){var o=e.get("access_token"),n=e.get("refresh_token");return o&&n?t.isTokenExpired(o)?r.refresh().then(function(t){var r=t.data.access_token;return e.set("access_token",r),r}):o:null}],e.interceptors.push("jwtInterceptor")}]),statracker.run(["$rootScope","$state","accountService",function(e,t,r){e.$on("$stateChangeStart",function(e,o){var n=r.user(),s=o&&o.data&&o.data.secure;!s||void 0!==n&&n.authenticated||(e.preventDefault(),t.go("login"))})}]),statracker.config(["$httpProvider",function(e){e.interceptors.push(["$rootScope","$q","$injector",function(e,t,r){var o;return{request:function(t){return e.$broadcast("loading:show"),t},response:function(t){return e.$broadcast("loading:hide"),t},responseError:function(n){return o=o||r.get("toaster"),e.$broadcast("loading:hide"),o.toastError(n.data.message?n.data.message:n.data.Message?n.data.Message:n.data),t.reject(n)}}}])}]),statracker.run(["$rootScope","$ionicLoading",function(e,t){e.$on("loading:show",function(){t.show({template:'<i class="icon ion-loading-b"></i>',noBackdrop:!0})}),e.$on("loading:hide",function(){t.hide()})}]),statracker.config(["$ionicConfigProvider",function(e){e.tabs.position("bottom"),e.backButton.previousTitleText(!1),e.backButton.icon("ion-ios7-arrow-left")}]).run(function(e){e.ready(function(){window.cordova&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),window.StatusBar&&StatusBar.styleDefault()})}),String.prototype.startsWith||Object.defineProperty(String.prototype,"startsWith",{enumerable:!1,configurable:!1,writable:!1,value:function(e,t){return t=t||0,this.lastIndexOf(e,t)===t}}),String.prototype.endsWith||Object.defineProperty(String.prototype,"endsWith",{value:function(e,t){var r=this.toString();(void 0===t||t>r.length)&&(t=r.length),t-=e.length;var o=r.indexOf(e,t);return-1!==o&&o===t}}),Array.prototype.find||(Array.prototype.find=function(e){if(null==this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof e)throw new TypeError("predicate must be a function");for(var t,r=Object(this),o=r.length>>>0,n=arguments[1],s=0;o>s;s++)if(t=r[s],e.call(n,t,s,r))return t;return void 0}),Array.prototype.findIndex||(Array.prototype.findIndex=function(e){if(null==this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof e)throw new TypeError("predicate must be a function");for(var t,r=Object(this),o=r.length>>>0,n=arguments[1],s=0;o>s;s++)if(t=r[s],e.call(n,t,s,r))return s;return-1}),statracker.config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("login",{url:"/login",templateUrl:"src/account/login-page.html"}).state("register",{url:"/register",templateUrl:"src/account/register-page.html"}).state("tab",{url:"/tab","abstract":!0,templateUrl:"src/tabs.html",resolve:{userData:["userDataService",function(e){return e.loadUserData()}]},data:{secure:!0}}).state("tab.user",{url:"/user",views:{settings:{templateUrl:"src/account/user-page.html"}}}).state("tab.course-list",{url:"/course-list",views:{settings:{templateUrl:"src/account/course-list-page.html",controller:"CourseListController as vm",resolve:{userData:["userDataService",function(e){return e.loadUserData()}]}}}}).state("tab.course-detail",{url:"/course-detail",params:{key:0},views:{settings:{templateUrl:"src/account/course-detail-page.html"}}}).state("tab.my-bag",{url:"/my-bag",views:{settings:{templateUrl:"src/account/my-bag-page.html",controller:"MyBagController as vm",resolve:{userData:["userDataService",function(e){return e.loadUserData()}]}}}}).state("tab.club-detail",{url:"/club-detail",params:{club:{}},views:{settings:{templateUrl:"src/account/club-detail-page.html"}}}).state("tab.rounds",{url:"/rounds",views:{rounds:{templateUrl:"src/rounds/list-page.html"}}}).state("tab.new-round",{url:"/new-round",views:{rounds:{templateUrl:"src/rounds/create-page.html",controller:"CreateRoundController as ctrl",resolve:{userData:["userDataService",function(e){return e.loadUserData()}]}}}}).state("tab.round-summary",{url:"/round-summary",views:{rounds:{templateUrl:"src/rounds/round-summary-page.html"}}}).state("tab.round-detail-teeball",{url:"/round-detail-teeball",views:{rounds:{templateUrl:"src/rounds/tee/tee-page.html",controller:"TeeShotController as ctrl",resolve:{userData:["userDataService",function(e){return e.loadUserData()}]}}}}).state("tab.round-detail-approach",{url:"/round-detail-approach",views:{rounds:{templateUrl:"src/rounds/approach/approach-page.html",controller:"ApproachShotController as ctrl",resolve:{userData:["userDataService",function(e){return e.loadUserData()}]}}}}).state("tab.round-detail-shortgame",{url:"/round-detail-shortgame",views:{rounds:{templateUrl:"src/rounds/shortgame/shortgame-page.html"}}}).state("tab.stats",{url:"/stats",views:{stats:{templateUrl:"src/stats/stats-page.html"}}}),t.otherwise("/tab/rounds")}]),statracker.factory("localStore",["store",function(e){return e.getNamespacedStore("stk")}]),statracker.factory("toaster",["$window","$ionicPopup","$timeout","$q",function(e,t,r,o){return{toastSuccess:function(e){var n=o.defer(),s=t.alert({title:"Success!",template:e});return s.then(function(){n.resolve(e)}),r(function(){s.close()},1500),n.promise},toastError:function(e){var n=o.defer(),s=t.alert({title:"Fail!",template:e});return s.then(function(){n.resolve(e)}),r(function(){s.close()},3e3),n.promise}}}]),statracker.controller("CreateRoundController",["$scope","$state","userDataService","roundService","userData","$ionicModal",function(e,t,r,o,n,s){var a=this;a.courses=n.courses,a.canStart=function(){return!0},a.startRound=function(){var e=a.courses.find(function(e){return e.key===a.round.courseKey}),r=o.create(e,a.round.date,a.round.holes);o.update(r,!0).then(function(){t.go("^.round-detail-teeball")})},a.courseSelected=function(){var e=a.courses.find(function(e){return e.key===a.round.courseKey});e&&(a.round.holes=e.holes)},a.getNewCourse=function(){a.modal.show()},a.newCourse=function(){r.addCourse(e.course).then(function(e){e&&(a.round.courseKey=e.key,a.round.holes=e.holesNumber)}),a.modal.hide()},a.hideModal=function(){a.modal.hide()},s.fromTemplateUrl("src/rounds/new-course-modal.html",{scope:e,animation:"slide-in-up"}).then(function(e){a.modal=e}),e.$on("$ionicView.beforeEnter",function(){a.round={date:new Date,holes:18,courseKey:0,isTournament:!1,hasError:!1,error:""},e.course={holes:18,course:"",tees:"",par:72}}),e.$watch("course.holes",function(t,r){t&&t!==r&&(e.course.par=18===t?72:36)}),e.$on("$destroy",function(){a.modal.remove()})}]),statracker.directive("goto",["$ionicPopover",function(e){return{restrict:"AE",template:'<button class="button button-small button-clear" ng-click="open($event)">Hole {{hole}}</button>',scope:{hole:"=",holes:"="},link:function(t){e.fromTemplateUrl("src/rounds/goto-popover.html",{scope:t}).then(function(e){t.popover=e}),t.open=function(e){t.popover.show(e)},t.goto=function(e){e<=t.holes&&t.$emit("hole_change",e),t.popover.hide()},t.$on("$destroy",function(){t.popover.remove()})}}}]),statracker.directive("holeNext",["$state","$ionicGesture","$ionicViewSwitcher","roundService",function(e,t,r,o){return{restrict:"A",link:function(n,s,a){var i=a.holeNext;t.on("swipe",function(t){"left"===t.gesture.direction&&(t.preventDefault(),r.nextDirection("forward"),e.is("tab.round-detail-shortgame")&&(r.nextDirection("swap"),o.getCurrentRound().then(function(e){var t=o.getCurrentHole();o.setCurrentHole(t==e.holes?1:t+1)})),e.go(i,e.params,{location:"replace"}))},s)}}}]),statracker.directive("holePrev",["$state","$ionicGesture","$ionicViewSwitcher","roundService",function(e,t,r,o){return{restrict:"A",link:function(n,s,a){var i=a.holePrev;t.on("swipe",function(t){"right"===t.gesture.direction&&(t.preventDefault(),r.nextDirection("back"),e.is("tab.round-detail-teeball")&&(r.nextDirection("swap"),o.getCurrentRound().then(function(e){var t=o.getCurrentHole();o.setCurrentHole(1==t?e.holes:t-1)})),e.go(i,e.params,{location:"replace"}))},s)}}}]),statracker.controller("ListRoundsController",["$state","$scope","roundService",function(e,t,r){var o=this;o.rounds=[],o.filter={holes:18,roundsToChart:10,monthsToList:3},t.$on("$ionicView.beforeEnter",function(){o.scores={},r.getAll().then(function(e){o.rounds=e.data,o.calculateRecentScores(o.filter.roundsToChart,o.filter.holes)})}),t.$watch(angular.bind(o,function(){return o.filter.holes}),function(e,t){e&&e!==t&&o.calculateRecentScores(o.filter.roundsToChart,o.filter.holes)}),o.calculateRecentScores=function(e,t){var r={},n=0;r.key=9===t?"Recent 9 hole rounds":"Recent 18 hole rounds",r.values=o.getRecentScores(o.rounds,t,e),n=r.values.reduce(function(e,t){return{value:e.value+t.value}},{value:0}),o.scores.average=n.value/r.values.length,o.scores.options={chart:{type:"discreteBarChart",height:160,title:{enable:!0,text:"Recent Scores"},margin:{top:20,right:10,bottom:10,left:10},color:["#88A65E"],x:function(e){return e.label},y:function(e){return e.value},showValues:!0,showYAxis:!1,showXAxis:!1,valueFormat:function(e){return d3.format("d")(e)},transitionDuration:500,discretebar:{dispatch:{elementClick:function(e){o.gotoSummary(e.point.label)}}}}},o.scores.data=[r]},o.gotoSummary=function(t){r.loadRound(t).then(function(){e.go("tab.round-summary")})},o.getRecentScores=function(e,t,r){var o,n,s=[];for(n=e.filter(function(e){return e.holes===t&&e.score>0}),o=0;r>o&&o<n.length;o++)s.push({label:n[o].key,value:n[o].score});return s}}]),statracker.controller("RoundController",["$scope","$state",function(e,t){e.round||(e.round={}),e.round.id=t.params.id,e.gotoDetails=function(){var e=t.params;e.hole=1,t.go("^.round-detail-teeball",e)}}]),statracker.factory("roundService",["$http","$q","localStore","apiUrl","accountService",function(e,t,r,o,n){var s,a=function(){var e=t.defer();if(s)e.resolve(s);else{var o=r.get("roundId");if(o)return i(o);e.reject()}return e.promise},i=function(n){var a,i=t.defer();return a&&a.key===n?i.resolve(a):e.get(o+"rounds/"+n).then(function(e){s=new statracker.Round(null,null,null,e.data),r.set("roundId",s.key),i.resolve(s)}),i.promise},u=function(t){return t||(t=20),e.get(o+"rounds?limit="+t)},c=function(e,t,o){return s=new statracker.Round(e,t,o),r.set("roundId",s.key),s},l=function(a,i){var u=t.defer();if(s=a,i){var c=s.toApi();c.userId=n.user().id,s.key&&s.key>0?e.put(o+"rounds/"+s.key,c).then(function(){r.set("roundId",s.key),u.resolve(s)}):e.post(o+"rounds",c).then(function(e){s.key=e.data.key,r.set("roundId",s.key),u.resolve(s)})}else r.set("roundId",s.key),u.resolve(s);return u.promise},d=function(e){return l(e,!0).then(function(){e.isComplete&&r.remove("roundId")})},h=function(t){return e.delete(o+"rounds/"+t).then(function(){s&&s.key===t&&(s=void 0,r.remove("roundId"))})};return{loadRound:i,getAll:u,getCurrentRound:a,setCurrentHole:function(e){r.set("hole",e)},getCurrentHole:function(){var e=r.get("hole");return e?e:1},create:c,update:l,complete:d,"delete":h}}]),statracker.controller("RoundSummaryController",["roundService","$state","$scope","toaster","$ionicPopup",function(e,t,r,o,n){var s=this;r.$on("$ionicView.beforeEnter",function(){e.getCurrentRound().then(function(e){s.round=e,s.stats=s.round.calculateStats()},function(){o.toastError("Failed to get the current round"),t.go("^.rounds")})}),s.deleteRound=function(){var r=n.confirm({title:"Delete Round",template:"Are you sure you want to permanently delete this round?"});r.then(function(r){r&&e.delete(s.round.key).then(function(){o.toastSuccess("Your round has been deleted").then(function(){t.go("^.rounds")})})})},s.saveRound=function(t){s.round.isComplete=t,e.complete(s.round).then(function(){o.toastSuccess("Your round has been saved")})},s.gotoDetails=function(){e.setCurrentHole(1),t.go("^.round-detail-teeball")},s.isComplete=function(){return s.round&&s.round.isComplete},s.hasDrivingStats=function(){if(s.round&&!s.round.isComplete)return!1;var e=s.round&&s.round.teeShots.some(function(e){return e.coordinates&&null!==e.coordinates.x});return e},s.hasApproachStats=function(){if(s.round&&!s.round.isComplete)return!1;var e=s.round&&s.round.approachShots.some(function(e){return e.coordinates&&null!==e.coordinates.x});return e},s.hasShortgameStats=function(){return s.round&&!s.round.isComplete?!1:s.stats&&s.stats.putting&&s.stats.putting.putts>0}}]),function(e){var t,r,o,n,s,a,i,u,c;t=function(t,r){var o;for(t.key=r.key,t.datePlayed=r.roundDate,t.courseKey=r.courseKey,t.courseDescription=r.course.courseDescription,t.holes=r.holesCount,t.score=r.scoreNumber,t.greens=r.greensNumber,t.fairways=r.fairwaysNumber,t.totalFairways=r.totalFairwaysNumber,t.isTournament=r.tournamentFlag,t.isComplete=r.completedFlag,t.notes=r.notesText,t.teeShots=[],t.approachShots=[],t.shortGameShots=[],o=0;o<r.holesCount;o++)t.teeShots.push(new e.TeeShot(o+1,r.teeShots[o])),t.approachShots.push(new e.ApproachShot(o+1,r.approachShots[o])),t.shortGameShots.push(new e.ShortGame(o+1,r.shortGameShots[o]))},o=function(r,o,n,s){var a;if(s)t(this,s);else for(this.key=void 0,this.courseKey=r.key,this.courseDescription=r.courseDescription,this.datePlayed=o,this.holes=n,this.score=void 0,this.greens=void 0,this.fairways=void 0,this.totalFairways=18===n?14:7,this.notes=void 0,this.isTournament=!1,this.isComplete=!1,this.teeShots=[],this.approachShots=[],this.shortGameShots=[],a=1;n>=a;a++)this.teeShots.push(new e.TeeShot(a)),this.approachShots.push(new e.ApproachShot(a)),this.shortGameShots.push(new e.ShortGame(a))},r=function(){var e,t={key:this.key,roundDate:this.datePlayed,courseKey:this.courseKey,holesCount:this.holes,scoreNumber:this.score,greensNumber:this.greens,fairwaysNumber:this.fairways,totalFairwaysNumber:this.totalFairways,notesText:this.notes,tournamentFlag:this.isTournament,completedFlag:this.isComplete,teeShots:[],approachShots:[],shortGameShots:[]};for(e=0;e<this.holes;e++)t.teeShots.push(this.teeShots[e].toApi(this.key)),t.approachShots.push(this.approachShots[e].toApi(this.key)),t.shortGameShots.push(this.shortGameShots[e].toApi(this.key));return t},n=function(e){var t=0,r=0,o=0;return e.teeShots.forEach(function(e){e.distance&&(r+=e.distance,t+=1,e.result%10===0&&(o+=1))}),0===t?0:{averageDistance:r/t,fairwaysHit:o}},i=function(e){var t=0,r=0,o=0,n=0;return e.approachShots.forEach(function(e){e.yardage&&(r+=e.yardage,t+=1,e.result<=24&&(n+=1))}),e.shortGameShots.forEach(function(e){!e.initialPuttLength||e.sandSave||e.upAndDown||(o+=e.initialPuttLength)}),{averageYardage:0===t?0:r/t,averageLeave:0===t?0:o/n,greensHit:n}},a=function(e){var t=0,r=0;return e.shortGameShots.forEach(function(e){e.putts&&(t+=e.putts),e.puttMadeLength&&(r+=e.puttMadeLength)}),{putts:t,madePutts:r}},u=function(e){var t=0,r=0,o=0;return e.shortGameShots.forEach(function(e){null!==e.upAndDown&&(r+=1,t+=e.upAndDown?1:0,e.initialPuttLength&&(o+=e.initialPuttLength))}),{attempts:r,conversions:t,percentage:0===r?0:100*t/r,averageLeave:0===r?0:o/r}},c=function(e){var t=0,r=0,o=0;return e.shortGameShots.forEach(function(e){null!==e.sandSave&&(r+=1,t+=e.sandSave?1:0,e.initialPuttLength&&(o+=e.initialPuttLength))}),{attempts:r,conversions:t,percentage:0===r?0:100*t/r,averageLeave:0===r?0:o/r}},s=function(){var e=n(this),t=i(this),r=a(this),o=u(this),s=c(this);return{driving:e,approachShots:t,putting:r,upAndDowns:o,sandSaves:s}},o.prototype={constructor:o,toApi:r,calculateStats:s},e.Round=o}(statracker),statracker.controller("StatsController",[function(){var e=this;e.stats={}}]),statracker.directive("approachResultInput",[function(){return{restrict:"AE",templateUrl:"src/rounds/approach/approach-result-input.html",replace:!0,scope:{shot:"=",round:"="},link:function(e,t){var r=t.find("path"),o=t[0].querySelector("svg"),n="http://www.w3.org/2000/svg",s="http://www.w3.org/1999/xlink",a=t[0].querySelector("#shots"),i=o.createSVGPoint(),u=function(e){return i.x=e.clientX,i.y=e.clientY,i.matrixTransform(o.getScreenCTM().inverse())},c=function(e,t,r){if(null==e||null==t)return void console.warn("x or y is null");var o=document.createElementNS(n,"use"),i="translate("+e+","+t+") scale(1.0)";r&&l(),o.setAttributeNS(s,"xlink:href","#ball"),o.setAttributeNS(null,"transform",i),a.appendChild(o)},l=function(){if(a.hasChildNodes())for(;a.firstChild;)a.removeChild(a.firstChild)};e.$watch("shot",function(){console.debug("shot watch"),e.shot&&(console.debug("shot exists"),l(),null!=e.shot.result&&e.shot.result>=0&&c(e.shot.coordinates.x,e.shot.coordinates.y,!0))}),r.bind("click",function(t){if(!e.round||!e.round.isComplete){var r=u(t);e.shot.result=parseInt(this.getAttribute("data-location")),console.debug("green click at "+e.shot.result),e.$emit("stk.approach",e.shot.getResultText()),e.shot.coordinates||(e.shot.coordinates={x:0,y:0}),e.shot.coordinates.x=r.x,e.shot.coordinates.y=r.y,c(r.x,r.y,!0)}})}}}]),statracker.directive("approachResultSummary",[function(){return{restrict:"AE",templateUrl:"src/rounds/approach/approach-result-input.html",replace:!0,scope:{round:"="},link:function(e,t){var r="http://www.w3.org/2000/svg",o="http://www.w3.org/1999/xlink",n=t[0].querySelector("#shots"),s=function(e,t,s){if(null!=e&&null!=t){var i=document.createElementNS(r,"use"),u="translate("+e+","+t+") scale(1.0)";s&&a(),i.setAttributeNS(o,"xlink:href","#ball"),i.setAttributeNS(null,"transform",u),n.appendChild(i)}},a=function(){if(n.hasChildNodes())for(;n.firstChild;)n.removeChild(n.firstChild)};e.$watch("round",function(){e.round&&e.round.approachShots&&(a(),e.round.approachShots.forEach(function(e){null!=e.coordinates&&s(e.coordinates.x,e.coordinates.y,!1)}))})}}}]),statracker.controller("ApproachShotController",["$state","$scope","roundService","userData",function(e,t,r,o){var n=this;n.gotoSummary=function(){e.go("^.round-summary")},t.$on("hole_change",function(e,t){r.update(n.round).then(function(){r.setCurrentHole(t),n.shot=n.round.approachShots[t-1],n.shotDescription=n.shot.getResultText()})}),t.$on("$ionicView.loaded",function(){n.clubs=o.clubs.reduce(function(e,t){return t.approachFlag&&e.push({key:t.clubKey,name:t.club.clubName}),e},[])}),t.$on("$ionicView.beforeEnter",function(){r.getCurrentRound().then(function(e){n.round=e,n.shot=n.round.approachShots[r.getCurrentHole()-1],n.shotDescription=n.shot.getResultText()})}),t.$on("$ionicView.beforeLeave",function(){r.update(n.round)}),t.$on("stk.approach",function(e,r){n.shotDescription=r,t.$apply()})}]),function(e){var t=["On the green, inside 3 feet","On the green, inside 12 feet, short","On the green, inside 12 feet, short right","On the green, inside 12 feet, right","On the green, inside 12 feet, long right","On the green, inside 12 feet, long","On the green, inside 12 feet, long left","On the green, inside 12 feet, left","On the green, inside 12 feet, short left","On the green, inside 30 feet, short","On the green, inside 30 feet, short right","On the green, inside 30 feet, right","On the green, inside 30 feet, long right","On the green, inside 30 feet, long","On the green, inside 30 feet, long left","On the green, inside 30 feet, left","On the green, inside 30 feet, short left","On the green, outside 30 feet, short","On the green, outside 30 feet, short right","On the green, outside 30 feet, right","On the green, outside 30 feet, long right","On the green, outside 30 feet, long","On the green, outside 30 feet, long left","On the green, outside 30 feet, left","On the green, outside 30 feet, short left","Missed green (less than 6 feet), short","Missed green (less than 6 feet), short right","Missed green (less than 6 feet), right","Missed green (less than 6 feet), long right","Missed green (less than 6 feet), long","Missed green (less than 6 feet), long left","Missed green (less than 6 feet), left","Missed green (less than 6 feet), short left","Missed green, short","Missed green, short right","Missed green, right","Missed green, long right","Missed green, long","Missed green, long left","Missed green, left","Missed green, short left"],r=function(e,t){t?(this.key=t.key,this.hole=t.holeNumber,this.clubKey=t.clubKey,this.yardage=t.yardageNumber,this.result=t.resultId,this.coordinates={x:t.resultX,y:t.resultY}):(this.key=void 0,this.hole=e,this.clubKey=void 0,this.yardage=void 0,this.result=void 0,this.coordinates=void 0)
},o=function(e){return{key:this.key,roundKey:e,holeNumber:this.hole,clubKey:this.clubKey,yardageNumber:this.yardage,resultId:this.result,resultX:this.coordinates?this.coordinates.x:void 0,resultY:this.coordinates?this.coordinates.y:void 0}},n=function(){return t[this.result]};r.prototype={constructor:r,toApi:o,getResultText:n},e.ApproachShot=r}(statracker),statracker.directive("attemptInput",[function(){return{restrict:"E",templateUrl:"src/rounds/shortgame/attempt-input.html",replace:!0,scope:{flag:"=",round:"="},link:function(e,t){var r=angular.element(t[0].querySelector("#make")),o=angular.element(t[0].querySelector("#miss")),n=r.find("line"),s=r.find("circle"),a=o.find("line"),i=o.find("circle"),u=function(){r.hasClass("attempt-unselected")||r.addClass("attempt-unselected"),r.hasClass("attempt-selected-make")&&r.removeClass("attempt-selected-make"),o.hasClass("attempt-unselected")||o.addClass("attempt-unselected"),o.hasClass("attempt-selected-miss")&&o.removeClass("attempt-selected-miss")},c=function(){r.hasClass("attempt-unselected")&&r.removeClass("attempt-unselected"),r.hasClass("attempt-selected-make")||r.addClass("attempt-selected-make"),o.hasClass("attempt-unselected")||o.addClass("attempt-unselected"),o.hasClass("attempt-selected-miss")&&o.removeClass("attempt-selected-miss")},l=function(){r.hasClass("attempt-unselected")||r.addClass("attempt-unselected"),r.hasClass("attempt-selected-make")&&r.removeClass("attempt-selected-make"),o.hasClass("attempt-unselected")&&o.removeClass("attempt-unselected"),o.hasClass("attempt-selected-miss")||o.addClass("attempt-selected-miss")},d=function(){e.flag===!0?c():e.flag===!1?l():u()},h=function(t){e.round&&e.round.isComplete||(t.stopPropagation(),console.debug("make click"),e.flag?(e.flag=void 0,u()):(e.flag=!0,c()))},f=function(t){e.round&&e.round.isComplete||(t.stopPropagation(),console.debug("miss click"),void 0===e.flag||e.flag===!0?(e.flag=!1,l()):(e.flag=void 0,u()))};e.$watch("flag",function(){d()}),r.bind("click",h),n.bind("click",h),s.bind("click",h),o.bind("click",f),a.bind("click",f),i.bind("click",f)}}}]),statracker.directive("puttsInput",[function(){return{restrict:"AE",templateUrl:"src/rounds/shortgame/putts-input.html",replace:!0,scope:{shot:"=",round:"="},link:function(e,t){var r=t.find("circle"),o=t.find("text"),n=function(){angular.forEach(r,function(e){var t=angular.element(e);t.hasClass("putt-unselected")||t.addClass("putt-unselected"),t.hasClass("putt-selected")&&t.removeClass("putt-selected")}),angular.forEach(o,function(e){var t=angular.element(e);t.hasClass("putt-unselected")||t.addClass("putt-unselected"),t.hasClass("putt-selected")&&t.removeClass("putt-selected")})},s=function(e){angular.forEach(r,function(t){var r=parseInt(t.getAttribute("data-value")),o=angular.element(t);r===e?(o.hasClass("putt-selected")||o.addClass("putt-selected"),o.hasClass("putt-unselected")&&o.removeClass("putt-unselected")):(o.hasClass("putt-unselected")||o.addClass("putt-unselected"),o.hasClass("putt-selected")&&o.removeClass("putt-selected"))}),angular.forEach(o,function(t){var r=parseInt(t.textContent),o=angular.element(t);r===e?(o.hasClass("putt-selected")||o.addClass("putt-selected"),o.hasClass("putt-unselected")&&o.removeClass("putt-unselected")):(o.hasClass("putt-unselected")||o.addClass("putt-unselected"),o.hasClass("putt-selected")&&o.removeClass("putt-selected"))})},a=function(){e.shot&&null!=e.shot.putts?s(e.shot.putts):n()};e.$watch("shot.putts",function(e){e?a():n()}),r.bind("click",function(){if(!e.round||!e.round.isComplete){var t=parseInt(this.getAttribute("data-value"));e.shot.putts=t,a()}}),o.bind("click",function(){if(!e.round||!e.round.isComplete){var t=parseInt(this.textContent);e.shot.putts=t,a()}})}}}]),statracker.controller("ShortGameController",["$state","$scope","roundService",function(e,t,r){var o=this;o.gotoSummary=function(){e.go("^.round-summary")},t.$on("hole_change",function(e,t){r.update(o.round).then(function(){r.setCurrentHole(t),o.shot=o.round.shortGameShots[t-1]})}),t.$on("$ionicView.beforeEnter",function(){r.getCurrentRound().then(function(e){o.round=e,o.shot=o.round.shortGameShots[r.getCurrentHole()-1]},function(){console.log("failed to get the current round - redirecting to rounds list"),e.go("^.rounds")})}),t.$on("$ionicView.beforeLeave",function(){r.update(o.round,!1)})}]),function(e){var t=function(e,t){t?(this.key=t.key,this.hole=t.holeNumber,this.initialPuttLength=t.initialLengthNumber,this.puttMadeLength=t.finalLengthNumber,this.putts=t.puttsCount,this.upAndDown=t.upAndDownFlag,this.sandSave=t.sandSaveFlag,this.holeOut=t.holeOutFlag):(this.key=void 0,this.hole=e,this.initialPuttLength=void 0,this.puttMadeLength=void 0,this.putts=void 0,this.upAndDown=void 0,this.sandSave=void 0,this.holeOut=void 0)},r=function(e){return{key:this.key,roundKey:e,holeNumber:this.hole,initialLengthNumber:this.initialPuttLength,finalLengthNumber:this.puttMadeLength,puttsCount:this.putts,upAndDownFlag:this.upAndDown,sandSaveFlag:this.sandSave,holeOutFlag:this.holeOut}};t.prototype={constructor:t,toApi:r},e.ShortGame=t}(statracker),statracker.directive("teeResultInput",[function(){return{restrict:"AE",templateUrl:"src/rounds/tee/tee-result-input.html",replace:!0,scope:{shot:"=",round:"="},link:function(e,t){var r=t.find("rect"),o=t[0].querySelector("svg"),n="http://www.w3.org/2000/svg",s="http://www.w3.org/1999/xlink",a=t[0].querySelector("#shots"),i=o.createSVGPoint(),u=function(e){return i.x=e.clientX,i.y=e.clientY,i.matrixTransform(o.getScreenCTM().inverse())},c=function(e,t,r){if(null==e||null==t)return void console.warn("x or y is null");var o=document.createElementNS(n,"use"),i="translate("+e+","+t+") scale(1.0)";r&&l(),o.setAttributeNS(s,"xlink:href","#ball"),o.setAttributeNS(null,"transform",i),a.appendChild(o)},l=function(){if(a.hasChildNodes())for(;a.firstChild;)a.removeChild(a.firstChild)},d=function(e){var t=Math.floor(e/10)-1,r=200;return r+5*t},h=function(t){var r=e.shot.coordinates&&e.shot.coordinates.x?e.shot.coordinates.x:170,o=372-2.4*(t-200);return{x:r,y:o}};e.$watch("shot",function(){e.shot&&(l(),null!=e.shot.result&&e.shot.result>=0&&c(e.shot.coordinates.x,e.shot.coordinates.y,!0))}),e.$watch("shot.distance",function(t,r){void 0!==t&&t!==r&&Number(t)>200&&(e.shot.coordinates=h(Number(t)),c(e.shot.coordinates.x,e.shot.coordinates.y,!0))}),r.bind("click",function(t){if(!e.round||!e.round.isComplete){var r=u(t);e.shot.result=parseInt(this.getAttribute("data-location")),e.shot.coordinates||(e.shot.coordinates={x:0,y:0}),e.shot.coordinates.x=r.x,e.shot.coordinates.y=r.y,e.$emit("tee_shot_distance",d(e.shot.result)),c(r.x,r.y,!0)}})}}}]),statracker.directive("teeResultSummary",[function(){return{restrict:"AE",templateUrl:"src/rounds/tee/tee-result-input.html",replace:!0,scope:{round:"="},link:function(e,t){var r="http://www.w3.org/2000/svg",o="http://www.w3.org/1999/xlink",n=t[0].querySelector("#shots"),s=function(e,t,s){if(null!=e&&null!=t){var i=document.createElementNS(r,"use"),u="translate("+e+","+t+") scale(1.0)";s&&a(),i.setAttributeNS(o,"xlink:href","#ball"),i.setAttributeNS(null,"transform",u),n.appendChild(i)}},a=function(){if(n.hasChildNodes())for(;n.firstChild;)n.removeChild(n.firstChild)};e.$watch("round",function(){e.round&&e.round.teeShots&&(a(),e.round.teeShots.forEach(function(e){null!=e.coordinates&&s(e.coordinates.x,e.coordinates.y,!1)}))})}}}]),statracker.controller("TeeShotController",["$state","$scope","roundService","userData",function(e,t,r,o){var n=this;n.gotoSummary=function(){e.go("^.round-summary")},t.$on("tee_shot_distance",function(e,r){n.shot.distance=r,t.$apply()}),t.$on("hole_change",function(e,t){r.update(n.round).then(function(){r.setCurrentHole(t),n.shot=n.round.teeShots[t-1]})}),t.$on("$ionicView.loaded",function(){n.clubs=o.clubs.reduce(function(e,t){return t.teeballFlag&&e.push({key:t.clubKey,name:t.club.clubName}),e},[])}),t.$on("$ionicView.beforeEnter",function(){r.getCurrentRound().then(function(e){n.round=e,n.shot=n.round.teeShots[r.getCurrentHole()-1]},function(){console.log("failed to get the current round - redirecting to rounds list"),e.go("^.rounds")})}),t.$on("$ionicView.beforeLeave",function(){r.update(n.round)})}]),function(e){var t=function(e,t){t?(this.key=t.key,this.hole=t.holeNumber,this.clubKey=t.clubKey,this.distance=t.distanceNumber,this.result=t.resultId,this.coordinates={x:t.resultX,y:t.resultY}):(this.key=void 0,this.hole=e,this.clubKey=void 0,this.distance=void 0,this.result=void 0,this.coordinates=void 0)},r=function(e){return{key:this.key,roundKey:e,holeNumber:this.hole,clubKey:this.clubKey,distanceNumber:this.distance,resultId:this.result,resultX:this.coordinates?this.coordinates.x:void 0,resultY:this.coordinates?this.coordinates.y:void 0}};t.prototype={constructor:t,toApi:r},e.TeeShot=t}(statracker);